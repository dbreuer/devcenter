<p>If you create a new iOS app on <a href="https://www.bitrise.io/">bitrise.io</a>
the generated default workflow wil include our <code>Xcode Archive</code> step.
This step can manage to archive and export your iOS app.</p>
<h2>A bit of history and technical info</h2>
<p>If the step is used with <code>Xcode 6</code> it'll generate the following (legacy) command to export
the <code>ipa</code> of your app (you can see it in the step's log):</p>
<pre><code>xcodebuild -exportArchive \
	-exportFormat ipa \
	-archivePath &quot;/var/folders/lb/8n5bn9k975qgw662jpqdy7mm0000gn/T/bitrise-xcarchive.YnAMfpzJ/ios-simple-objc.xcarchive&quot; \
	-exportPath &quot;/Users/vagrant/deploy/ios-simple-objc.ipa&quot; \
	-exportProvisioningProfile &quot;Xyz&quot;
</code></pre>
<p>Back in the days of Xcode 6 this was everything you had to do; just specify the format to be <code>ipa</code>
and set the required paths and the Provisioning Profile to be used for code signing the <code>ipa</code>.</p>
<p><code>Xcode 7</code> introduced a lot of additional archive feature and the support for
defining more complex archive parameters. This meant that although Xcode 7 still supports
the old parameters, it's now declared as <strong>deprecated</strong>, and you'd get
the following warning if you'd use the old parameters instead of the new <code>-exportOptionsPlist</code> parameter:</p>
<pre><code>xcodebuild: WARNING: -exportArchive without -exportOptionsPlist is deprecated
</code></pre>
<p>The export command's <strong>new version</strong> expects a Plist file (<code>-exportOptionsPlist</code>),
which should include all the archive parameters (including code signing type/method,
and other parameters like enable/disable Bitcode). The full command looks like this:</p>
<pre><code>xcodebuild -exportArchive \
	-archivePath &quot;/var/folders/lb/8n5bn9k975qgw662jpqdy7mm0000gn/T/bitrise-xcarchive.QbpHVvNx/ios-simple-objc.xcarchive&quot; \
	-exportPath &quot;/var/folders/lb/8n5bn9k975qgw662jpqdy7mm0000gn/T/bitrise-xcarchive.aCvNPRAi&quot; \
	-exportOptionsPlist &quot;/Users/vagrant/deploy/export_options.plist&quot;
</code></pre>
<p>By default the <code>Xcode Archive</code> step generates the minimal sufficient Plist file,
with only the export <code>method</code> defined in it (unless you specify the <code>export_options_path</code> input,
we'll get back to this a bit later):</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE plist PUBLIC &quot;-//Apple Computer//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;
&lt;plist version=&quot;1.0&quot;&gt;
&lt;dict&gt;
	&lt;key&gt;method&lt;/key&gt;
	&lt;string&gt;development&lt;/string&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>
<h2>About the Xcode Archive step generated export options</h2>
<p>The default <strong>generated</strong> export options Plist file only specifies
the <strong>export method</strong> (<code>app-store</code>, <code>ad-hoc</code>, <code>enterprise</code> or <code>development</code>)
based on the provisioning profile embedded in the <code>.xcarchive</code> (which is generated by the <code>xcodebuild archive</code>
command, also performed by the <code>Xcode Archive</code> step, right before the <code>xcodebuild -exportArchive</code> command).</p>
<p><em>The embedded provisioning profile depends on your code sign settings in your project.
You can force the desired code signing configuration
with <code>Xcode Archive</code> step's <code>force_code_sign_identity</code> and <code>force_provisioning_profile</code> inputs.
You can find more information about these options in the <a href="ios/code-signing">iOS Code Signing</a> article.</em></p>
<p>Every other export option which can be defined in the Plist is optional.</p>
<h2>Use your own export options</h2>
<p>In case of the default export_options.plist does not fit your needs,
you can specify your own export options too.
To do this create a plist file (in your repository) with the options you want to use.</p>
<p>!!! note &quot;Available export options&quot;
You can get a list of all available options by calling <code>xcodebuild -h</code> -
check the <strong>Available keys for -exportOptionsPlist:</strong> section of the printed help.</p>
<p><em>These are the options you can select in Xcode when you export the ipa manually.</em></p>
<p>The <strong>recommanded</strong> way is to <strong>put this generated plist file in your project's repository</strong>.
Then you can set <code>Xcode Archive</code> step's <code>export_options_path</code> input
to the path of your plist file (e.g. <code>./path/to/export-options.plist</code>).</p>
<h3>Disable bitcode in ipa</h3>
<p><strong>By default uploadBitcode export options is set to YES</strong>, unless you specifically disable
it in the export options Plist.
If it does not fit your requirements you have to use your own export options,
instead of the archive steps generated one.</p>
<p>Your export options plist should look like:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE plist PUBLIC &quot;-//Apple Computer//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;
&lt;plist version=&quot;1.0&quot;&gt;
&lt;dict&gt;
	&lt;key&gt;method&lt;/key&gt;
	&lt;string&gt;app-store&lt;/string&gt;
	&lt;key&gt;uploadBitcode&lt;/key&gt;
	&lt;false/&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>
<p>!!! note &quot;Code Signing note&quot;
Of course, if you set the <code>method</code> to <code>app-store</code> then you have to upload / use
an App Store code signing Identity &amp; Provisioning Profile (it have to be
available in the system).</p>
<h3>Related issues:</h3>
<h4>ERROR ITMS-90635: Invalid Mach-O Format</h4>
<pre><code>Transporter Error Output: ERROR ITMS-90635: Invalid Mach-O Format.
...
Verify that all of the targets for a platform have a consistent value for the ENABLE_BITCODE build setting.
...
</code></pre>
<p>This error occurs if you have different <code>ENABLE_BITCODE</code> settings
in your (sub)projects, including the projects generated by CocoaPods for example.</p>
<p>If you use CocoaPods you can <strong>override the <code>ENABLE_BITCODE</code> in the pod projects</strong> by adding
the following section to your <code>Podfile</code>:</p>
<p>For CocoaPods 1.0+:</p>
<pre><code>post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['ENABLE_BITCODE'] = 'NO'
    end
  end
end
</code></pre>
<p>For CocoaPods 0.39 and below:</p>
<pre><code>post_install do |installer|
  installer.project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['ENABLE_BITCODE'] = 'NO'
    end
  end
end
</code></pre>
